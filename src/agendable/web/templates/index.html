{% extends "base.html" %}

{% block title %}Agendable â€” Series{% endblock %}

{% block content %}
<section>
    <h2>Meeting series</h2>

    {% if not current_user %}
    <p><em>Sign in to create and view meeting series.</em></p>
    {% else %}
    <form method="post" action="/series" class="form-grid">
        <label>
            Title
            <input name="title" required />
        </label>

        <label>
            Repeat
            <select id="recurrence-freq" name="recurrence_freq" required hx-get="/series/recurrence-options"
                hx-target="#recurrence-options" hx-swap="innerHTML">
                <option value="DAILY">Daily</option>
                <option value="WEEKLY">Weekly</option>
                <option value="MONTHLY">Monthly</option>
            </select>
        </label>
        <label>
            Every
            <input name="recurrence_interval" type="number" min="1" max="365" value="1" required />
        </label>

        <div id="recurrence-options" class="span-all">
            {% include "partials/series_recurrence_options.html" %}
        </div>

        <label>
            Time
            <input name="recurrence_time" type="time" value="09:00" required />
        </label>
        <label>
            Time zone
            <select id="recurrence-timezone" name="recurrence_timezone" required>
                {% set selected_tz = current_user.timezone if current_user and current_user.timezone else "UTC" %}
                {% set ns = namespace(found=false) %}
                {% for tz_value, tz_label in timezone_options %}
                {% if tz_value == selected_tz %}{% set ns.found = true %}{% endif %}
                <option value="{{ tz_value }}" {% if tz_value==selected_tz %}selected{% endif %}>{{ tz_label }}</option>
                {% endfor %}
                {% if selected_tz and not ns.found %}
                <option value="{{ selected_tz }}" selected>{{ selected_tz }} (custom)</option>
                {% endif %}
            </select>
        </label>
        <label>
            Start date
            <input name="recurrence_start_date" type="date" required />
        </label>
        <label>
            Generate
            <input name="generate_count" type="number" min="1" max="200" value="10" required />
        </label>
        <label>
            Reminder lead (minutes)
            <input name="reminder_minutes_before" type="number" min="0" max="43200" value="60" required />
        </label>

        <button type="submit">Create</button>
    </form>

    <ul>
        {% for s in series %}
        <li>
            <a href="/series/{{ s.id }}">{{ s.title }}</a>
            <small>({{ series_recurrence.get(s.id, "") }})</small>
        </li>
        {% else %}
        <li><em>No series yet. Create your first recurring meeting above, then open it to add agenda and tasks.</em>
        </li>
        {% endfor %}
    </ul>
    {% endif %}
</section>

<script>
    (() => {
        const tzInput = document.getElementById("recurrence-timezone");
        if (!tzInput) return;

        const systemTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (!systemTz) return;

        const hasSystemTz = Array.from(tzInput.options).some((opt) => opt.value === systemTz);
        if (hasSystemTz && (!tzInput.value || tzInput.value === "UTC")) {
            tzInput.value = systemTz;
        }
    })();
</script>
{% endblock %}