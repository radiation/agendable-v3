{% extends "base.html" %}

{% block title %}Agendable — Profile{% endblock %}

{% block content %}
<a class="back-link" href="/">← Back</a>

<section class="stack-lg">
    <div class="section-title">
        <h2>Profile</h2>
    </div>

    <section class="section-card">
        <h3>Account settings</h3>
        <form method="post" action="/profile" class="form-grid">
            <label>
                First name
                <input name="first_name" value="{{ user.first_name }}" required />
            </label>
            <label>
                Last name
                <input name="last_name" value="{{ user.last_name }}" />
            </label>
            <label>
                Timezone
                <select id="profile-timezone" name="timezone" required>
                    {% set ns = namespace(found=false) %}
                    {% for tz_value, tz_label in timezone_options %}
                    {% if tz_value == user.timezone %}{% set ns.found = true %}{% endif %}
                    <option value="{{ tz_value }}" {% if tz_value==user.timezone %}selected{% endif %}>{{ tz_label }}
                    </option>
                    {% endfor %}
                    {% if user.timezone and not ns.found %}
                    <option value="{{ user.timezone }}" selected>{{ user.timezone }} (custom)</option>
                    {% endif %}
                </select>
            </label>
            <label class="inline span-all">
                <input type="checkbox" name="prefers_dark_mode" {% if user.prefers_dark_mode %}checked{% endif %} />
                Dark mode
            </label>
            <div class="span-all">
                <button type="submit">Save</button>
            </div>
        </form>
    </section>

    <section class="section-card">
        <h3>Account details</h3>
        <ul class="list-clean">
            <li><strong>Email:</strong> {{ user.email }}</li>
            <li><strong>Name:</strong> {{ user.full_name }}</li>
            <li><strong>Timezone:</strong> {{ user.timezone }}</li>
            <li><strong>Created:</strong> {{ user.created_at }}</li>
        </ul>
    </section>

    <section class="section-card">
        <h3>Linked sign-in methods</h3>
        {% if identity_error %}
        <p class="field-error"><strong>{{ identity_error }}</strong></p>
        {% endif %}

        {% if oidc_enabled %}
        <form method="post" action="/profile/identities/link/start" class="form-grid">
            {% if user.password_hash %}
            <label>
                Current password
                <input type="password" name="password" required />
            </label>
            {% endif %}
            <div>
                <button type="submit">Link SSO account</button>
            </div>
        </form>
        {% endif %}

        <ul class="list-clean">
            {% for identity in identities %}
            <li>
                <strong>{{ identity.provider }}</strong>
                <small>— {{ identity.email or user.email }}</small>
                <form method="post" action="/profile/identities/{{ identity.id }}/unlink" class="inline-actions">
                    <button type="submit">Unlink</button>
                </form>
            </li>
            {% else %}
            <li><em>No external sign-in methods linked.</em></li>
            {% endfor %}
        </ul>
    </section>
</section>

<script>
    (() => {
        const tzInput = document.getElementById("profile-timezone");
        if (!tzInput) return;

        const systemTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (!systemTz) return;

        const hasSystemTz = Array.from(tzInput.options).some((opt) => opt.value === systemTz);
        if (hasSystemTz && !tzInput.value) {
            tzInput.value = systemTz;
        }
    })();
</script>
{% endblock %}