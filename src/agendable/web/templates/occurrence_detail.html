{% extends "base.html" %}

{% block title %}Agendable — {{ series.title }} (meeting){% endblock %}

{% block content %}
<a class="back-link" href="/series/{{ series.id }}">← Back to series</a>

<section class="stack-lg">
    <section class="section-card">
        <h2>{{ series.title }}</h2>
        <p><small>Repeats: {{ recurrence_label }}</small></p>
        <p><strong>Scheduled:</strong> {{ occurrence.scheduled_at|format_dt(current_user.timezone) }}</p>
        {% if occurrence.is_completed %}
        <div class="inline-actions">
            <strong>Status:</strong> <span class="status-pill">Completed</span>
        </div>
        {% else %}
        <form method="post" action="/occurrences/{{ occurrence.id }}/complete">
            <button type="submit">Complete meeting & roll unfinished items forward</button>
        </form>
        {% endif %}
    </section>

    <section class="section-card">
        <h3>Attendees</h3>
        {% if not occurrence.is_completed %}
        <form method="post" action="/occurrences/{{ occurrence.id }}/attendees" class="inline-form">
            <label>
                Add attendee (email)
                <input name="email" type="email" value="{{ attendee_form.email }}" required />
                {% if attendee_form_errors.email %}
                <small class="field-error">{{ attendee_form_errors.email }}</small>
                {% endif %}
            </label>
            <button type="submit">Add attendee</button>
        </form>
        {% else %}
        <p><small>Meeting is completed, so attendees are read-only.</small></p>
        {% endif %}

        <ul class="list-clean">
            {% for attendee in attendee_users %}
            <li>{{ attendee.full_name }}</li>
            {% else %}
            <li><em>No attendees yet.</em></li>
            {% endfor %}
        </ul>
    </section>

    <section class="section-card">
        <h3>Tasks</h3>

        {% if not occurrence.is_completed %}
        <form method="post" action="/occurrences/{{ occurrence.id }}/tasks" class="inline-form">
            <label>
                Task
                <input name="title" value="{{ task_form.title }}" required />
                {% if task_form_errors.title %}
                <small class="field-error">{{ task_form_errors.title }}</small>
                {% endif %}
            </label>
            <label>
                Description (optional)
                <textarea name="description" rows="2">{{ task_form.description }}</textarea>
            </label>
            <label>
                Assignee
                <select name="assigned_user_id">
                    {% for attendee in attendee_users %}
                    <option value="{{ attendee.id }}" {% if task_form.assigned_user_id==attendee.id|string %}selected{%
                        endif %}>{{ attendee.full_name }}</option>
                    {% endfor %}
                </select>
                {% if task_form_errors.assigned_user_id %}
                <small class="field-error">{{ task_form_errors.assigned_user_id }}</small>
                {% endif %}
            </label>
            <label>
                Due at (local time)
                <input name="due_at" type="datetime-local" value="{{ task_form.due_at }}" required />
                {% if task_form_errors.due_at %}
                <small class="field-error">{{ task_form_errors.due_at }}</small>
                {% endif %}
            </label>
            <button type="submit">Add task</button>
        </form>
        {% else %}
        <p><small>Meeting is completed, so tasks are read-only.</small></p>
        {% endif %}

        <ul class="list-clean">
            {% for t in tasks %}
            <li>
                {% if not occurrence.is_completed %}
                <form method="post" action="/tasks/{{ t.id }}/toggle" class="inline-actions">
                    <button type="submit">{% if t.is_done %}Undo{% else %}Done{% endif %}</button>
                </form>
                {% endif %}
                {% if t.is_done %}<s>{{ t.title }}</s>{% else %}{{ t.title }}{% endif %}
                {% if t.description %}
                <small>— {{ t.description }}</small>
                {% endif %}
                <small>— {{ t.assignee.full_name }}</small>
                <small>— due {{ t.due_at|format_dt(current_user.timezone) }}</small>
            </li>
            {% else %}
            <li><em>No tasks yet. Add one above to capture a follow-up before the meeting ends.</em></li>
            {% endfor %}
        </ul>
    </section>

    <section class="section-card">
        <h3>Agenda</h3>

        {% if not occurrence.is_completed %}
        <form method="post" action="/occurrences/{{ occurrence.id }}/agenda" class="inline-form">
            <label>
                Agenda item
                <input name="body" value="{{ agenda_form.body }}" required />
                {% if agenda_form_errors.body %}
                <small class="field-error">{{ agenda_form_errors.body }}</small>
                {% endif %}
            </label>
            <label>
                Description (optional)
                <textarea name="description" rows="2">{{ agenda_form.description }}</textarea>
            </label>
            <button type="submit">Add</button>
        </form>
        {% else %}
        <p><small>Meeting is completed, so agenda is read-only.</small></p>
        {% endif %}

        <ul class="list-clean">
            {% for a in agenda_items %}
            <li>
                {% if not occurrence.is_completed %}
                <form method="post" action="/agenda/{{ a.id }}/toggle" class="inline-actions">
                    <button type="submit">{% if a.is_done %}Undo{% else %}Done{% endif %}</button>
                </form>
                {% endif %}
                {% if a.is_done %}<s>{{ a.body }}</s>{% else %}{{ a.body }}{% endif %}
                {% if a.description %}
                <small>— {{ a.description }}</small>
                {% endif %}
                {% if not occurrence.is_completed and not a.is_done %}
                <form method="post" action="/agenda/{{ a.id }}/convert-to-task" class="inline-actions">
                    <select name="assigned_user_id">
                        {% for attendee in attendee_users %}
                        <option value="{{ attendee.id }}">{{ attendee.full_name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Convert to task</button>
                </form>
                {% endif %}
            </li>
            {% else %}
            <li><em>No agenda items yet. Start with one key topic to guide this meeting.</em></li>
            {% endfor %}
        </ul>
    </section>
</section>
{% endblock %}