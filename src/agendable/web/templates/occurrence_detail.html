{% extends "base.html" %}

{% block title %}Agendable — {{ series.title }} (meeting){% endblock %}

{% block content %}
<p><a href="/series/{{ series.id }}">← Back to series</a></p>

<section>
    <h2>{{ series.title }}</h2>
    <p><small>Repeats: {{ recurrence_label }}</small></p>
    <p><strong>Scheduled:</strong> {{ occurrence.scheduled_at }}</p>
    {% if occurrence.is_completed %}
    <p><strong>Status:</strong> Completed</p>
    {% else %}
    <form method="post" action="/occurrences/{{ occurrence.id }}/complete">
        <button type="submit">Complete meeting & roll unfinished items forward</button>
    </form>
    {% endif %}
</section>

<hr />

<section>
    <h3>Attendees</h3>
    {% if not occurrence.is_completed %}
    <form method="post" action="/occurrences/{{ occurrence.id }}/attendees"
        style="display:flex; gap: .5rem; flex-wrap: wrap; align-items: end;">
        <label>
            Add attendee (email)
            <input name="email" type="email" required />
        </label>
        <button type="submit">Add attendee</button>
    </form>
    {% else %}
    <p><small>Meeting is completed, so attendees are read-only.</small></p>
    {% endif %}

    <ul>
        {% for attendee in attendee_users %}
        <li>{{ attendee.full_name }}</li>
        {% else %}
        <li><em>No attendees yet.</em></li>
        {% endfor %}
    </ul>
</section>

<hr />

<section>
    <h3>Tasks</h3>

    {% if not occurrence.is_completed %}
    <form method="post" action="/occurrences/{{ occurrence.id }}/tasks"
        style="display:flex; gap: .5rem; flex-wrap: wrap; align-items: end;">
        <label>
            Task
            <input name="title" required />
        </label>
        <label>
            Assignee
            <select name="assigned_user_id">
                {% for attendee in attendee_users %}
                <option value="{{ attendee.id }}">{{ attendee.full_name }}</option>
                {% endfor %}
            </select>
        </label>
        <label>
            Due at (UTC)
            <input name="due_at" type="datetime-local" value="{{ task_due_default_value }}" required />
        </label>
        <button type="submit">Add task</button>
    </form>
    {% else %}
    <p><small>Meeting is completed, so tasks are read-only.</small></p>
    {% endif %}

    <ul>
        {% for t in tasks %}
        <li>
            {% if not occurrence.is_completed %}
            <form method="post" action="/tasks/{{ t.id }}/toggle" style="display:inline;">
                <button type="submit">{% if t.is_done %}Undo{% else %}Done{% endif %}</button>
            </form>
            {% endif %}
            {% if t.is_done %}<s>{{ t.title }}</s>{% else %}{{ t.title }}{% endif %}
            <small>— {{ t.assignee.full_name }}</small>
            <small>— due {{ t.due_at }}</small>
        </li>
        {% else %}
        <li><em>No tasks yet.</em></li>
        {% endfor %}
    </ul>
</section>

<hr />

<section>
    <h3>Agenda</h3>

    {% if not occurrence.is_completed %}
    <form method="post" action="/occurrences/{{ occurrence.id }}/agenda"
        style="display:flex; gap: .5rem; flex-wrap: wrap; align-items: end;">
        <label>
            Agenda item
            <input name="body" required />
        </label>
        <button type="submit">Add</button>
    </form>
    {% else %}
    <p><small>Meeting is completed, so agenda is read-only.</small></p>
    {% endif %}

    <ul>
        {% for a in agenda_items %}
        <li>
            {% if not occurrence.is_completed %}
            <form method="post" action="/agenda/{{ a.id }}/toggle" style="display:inline;">
                <button type="submit">{% if a.is_done %}Undo{% else %}Done{% endif %}</button>
            </form>
            {% endif %}
            {% if a.is_done %}<s>{{ a.body }}</s>{% else %}{{ a.body }}{% endif %}
        </li>
        {% else %}
        <li><em>No agenda items yet.</em></li>
        {% endfor %}
    </ul>
</section>
{% endblock %}